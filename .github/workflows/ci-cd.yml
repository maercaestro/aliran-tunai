name: Backend CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============= TESTING PHASE =============
  test-python:
    name: Test Python Backend
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr tesseract-ocr-eng
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock pytest-asyncio python-dotenv
        pip install flake8 black isort mypy bandit safety
        
    - name: Create test environment file
      run: |
        cat > .env.test << EOF
        MONGO_URI=mongodb://testuser:testpass@localhost:27017/test_db?authSource=admin
        TELEGRAM_BOT_TOKEN=test_token_for_ci
        OPENAI_API_KEY=test_openai_key
        WHATSAPP_VERIFY_TOKEN=test_verify_token
        WHATSAPP_ACCESS_TOKEN=test_access_token
        WHATSAPP_PHONE_NUMBER_ID=test_phone_id
        FLASK_ENV=testing
        EOF
        
    - name: Run environment validation
      run: |
        echo "Running environment validation..."
        python scripts/validate_environment.py || echo "Environment validation completed with warnings"
        
    - name: Run code quality checks
      run: |
        echo "Running code formatting checks..."
        black --check . || echo "Code formatting issues found - fix with 'black .'"
        echo "Running import sorting checks..."
        isort --check-only . || echo "Import sorting issues found - fix with 'isort .'"
        echo "Running linting..."
        flake8 . --max-line-length=120 --extend-ignore=E203,W503 || echo "Linting issues found"
        
    - name: Run type checking
      run: |
        echo "Running type checking..."
        mypy . --ignore-missing-imports --no-strict-optional || echo "Type checking completed with issues"
        
    - name: Run security checks
      run: |
        echo "Running security analysis..."
        bandit -r . -f json -o bandit-report.json || true
        echo "Checking for vulnerabilities in dependencies..."
        safety check --json --output safety-report.json || true
        
    - name: Run unit tests with coverage
      run: |
        echo "Running unit tests..."
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term || echo "Some tests failed"
      env:
        PYTHONPATH: .
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          htmlcov/
          bandit-report.json
          safety-report.json

  # ============= INTEGRATION TESTING =============
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python]
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio requests
        
    - name: Create integration test environment
      run: |
        cat > .env.integration << EOF
        MONGO_URI=mongodb://testuser:testpass@localhost:27017/integration_test_db?authSource=admin
        TELEGRAM_BOT_TOKEN=integration_test_token
        OPENAI_API_KEY=integration_test_key
        WHATSAPP_VERIFY_TOKEN=integration_verify_token
        WHATSAPP_ACCESS_TOKEN=integration_access_token
        WHATSAPP_PHONE_NUMBER_ID=integration_phone_id
        FLASK_ENV=testing
        EOF
        
    - name: Run integration tests
      run: |
        echo "Starting integration tests..."
        python -m pytest integration_tests/ -v || echo "Integration tests completed with some failures"
      env:
        PYTHONPATH: .

  # ============= DEPLOYMENT PHASE =============
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [test-python, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup SSH key
      run: |
        echo "=== SSH Key Setup Debug ==="
        echo "Creating SSH directory..."
        mkdir -p ~/.ssh
        
        echo "Checking if EC2_SSH_PRIVATE_KEY secret exists..."
        if [ -z "${{ secrets.EC2_SSH_PRIVATE_KEY }}" ]; then
          echo "ERROR: EC2_SSH_PRIVATE_KEY secret is empty or not set!"
          exit 1
        else
          echo "EC2_SSH_PRIVATE_KEY secret found (length: ${#EC2_SSH_PRIVATE_KEY})"
        fi
        
        echo "Writing private key to file..."
        # Use printf to avoid potential issues with echo and newlines
        printf '%s\n' '${{ secrets.EC2_SSH_PRIVATE_KEY }}' > ~/.ssh/id_rsa
        
        echo "Fixing line endings (removing Windows CRLF if present)..."
        sed -i 's/\r$//' ~/.ssh/id_rsa
        
        echo "Removing any extra blank lines at the end..."
        sed -i '/^$/d' ~/.ssh/id_rsa
        
        echo "Setting correct permissions on private key..."
        chmod 600 ~/.ssh/id_rsa
        
        echo "Checking private key file..."
        ls -la ~/.ssh/id_rsa
        echo "First line of key file:"
        head -1 ~/.ssh/id_rsa
        echo "Last line of key file:"
        tail -1 ~/.ssh/id_rsa
        
        echo "Checking if EC2_HOST is set..."
        if [ -z "${{ secrets.EC2_HOST }}" ]; then
          echo "ERROR: EC2_HOST secret is empty or not set!"
          exit 1
        else
          echo "EC2_HOST: ${{ secrets.EC2_HOST }}"
        fi
        
        echo "Adding EC2 host to known_hosts..."
        echo "Testing connectivity to EC2_HOST..."
        nc -zv ${{ secrets.EC2_HOST }} 22 || echo "Port 22 not reachable on ${{ secrets.EC2_HOST }}"
        
        echo "Running ssh-keyscan..."
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || echo "ssh-keyscan failed"
        
        echo "Contents of known_hosts:"
        cat ~/.ssh/known_hosts
        
        echo "Validating SSH key format..."
        echo "Key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
        echo "Key file line count: $(wc -l < ~/.ssh/id_rsa) lines"
        echo "Checking for Windows line endings..."
        file ~/.ssh/id_rsa || echo "file command not available"
        echo "Checking key format with openssl..."
        openssl rsa -in ~/.ssh/id_rsa -check -noout || echo "OpenSSL key validation failed"
        echo "Checking with ssh-keygen..."
        ssh-keygen -l -f ~/.ssh/id_rsa || echo "WARNING: Key validation failed"
        
        echo "=== SSH Key Setup Complete ==="
      env:
        EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        
    - name: Test SSH connection
      run: |
        echo "Testing SSH connection to EC2..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          echo "SSH connection successful!"
          echo "Current user: $(whoami)"
          echo "Operating system:"
          cat /etc/os-release | grep PRETTY_NAME
          echo "Python availability:"
          which python3 || echo "python3 not found"
          python3 --version || echo "python3 version check failed"
          echo "Available Python packages:"
          which yum && echo "yum available" || echo "yum not available"
          echo "Home directory contents:"
          ls -la ~/
        EOF
        
    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        echo "Current directory: $(pwd)"
        echo "Available disk space:"
        df -h .
        echo "Directory contents:"
        ls -la
        echo "Checking for problematic files..."
        find . -name "*.tmp" -o -name "*.temp" -o -name "*.log" | head -10
        echo "Running tar command with verbose output..."
        tar -czvf deployment-package.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='.pytest_cache' \
          --exclude='htmlcov' \
          --exclude='*.log' \
          --exclude='.env*' \
          --exclude='venv' \
          --exclude='aliran' \
          --exclude='*.pyc' \
          --exclude='.DS_Store' \
          --exclude='*.tmp' \
          --exclude='*.temp' \
          . || {
            echo "❌ Tar command failed with exit code $?"
            echo "Trying simpler approach..."
            tar -czf deployment-package.tar.gz \
              --exclude='.git' \
              --exclude='node_modules' \
              --exclude='__pycache__' \
              . || {
                echo "❌ Even basic tar failed!"
                echo "File system status:"
                ls -la
                df -h .
                exit 1
              }
          }
        echo "✅ Deployment package created successfully"
        ls -la deployment-package.tar.gz
        
    - name: Upload to EC2
      run: |
        echo "Uploading deployment package to EC2..."
        scp -i ~/.ssh/id_rsa deployment-package.tar.gz ec2-user@${{ secrets.EC2_HOST }}:/tmp/
        
    - name: Deploy on EC2
      run: |
        ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "Starting deployment process..."
          
          # Stop and clean up existing services first
          echo "Stopping existing services..."
          sudo systemctl stop aliran-tunai || echo "aliran-tunai service not running"
          sudo systemctl stop aliran-api-server || echo "aliran-api-server service not running"
          sudo systemctl stop aliran-whatsapp || echo "aliran-whatsapp service not running"
          sudo systemctl disable aliran-tunai || echo "aliran-tunai service not enabled"
          sudo systemctl disable aliran-api-server || echo "aliran-api-server service not enabled"  
          sudo systemctl disable aliran-whatsapp || echo "aliran-whatsapp service not enabled"
          
          # Clean up old service files
          echo "Cleaning up old service configurations..."
          sudo rm -f /etc/systemd/system/aliran-tunai.service
          sudo rm -f /etc/systemd/system/aliran-api-server.service
          sudo rm -f /etc/systemd/system/aliran-whatsapp.service
          sudo systemctl daemon-reload
          sudo systemctl reset-failed || echo "No failed services to reset"
          
          # Create application directory if it doesn't exist
          sudo mkdir -p /opt/aliran-tunai
          cd /opt/aliran-tunai
          
          # Backup current deployment
          if [ -d "current" ]; then
            echo "Backing up current deployment..."
            sudo rm -rf backup || true
            sudo mv current backup
          fi
          
          # Extract new deployment
          echo "Extracting new deployment..."
          sudo mkdir -p current
          cd current
          sudo tar -xzf /tmp/deployment-package.tar.gz
          sudo chown -R ec2-user:ec2-user .
          
          # Install system dependencies for Amazon Linux
          echo "Installing system dependencies..."
          sudo yum update -y
          sudo yum install -y gcc openssl-devel bzip2-devel libffi-devel zlib-devel wget make git tar xz-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel libpcap-devel || echo "Some optional dependencies may not be available"
          
          # Install Python 3.12 if not available
          if ! command -v /usr/local/bin/python3.12 &> /dev/null; then
            echo "Installing Python 3.12..."
            cd /tmp
            wget https://www.python.org/ftp/python/3.12.0/Python-3.12.0.tgz
            tar xzf Python-3.12.0.tgz
            cd Python-3.12.0
            ./configure --enable-optimizations --prefix=/usr/local
            sudo make altinstall
            echo "Python 3.12 installation completed"
          else
            echo "Python 3.12 already installed"
          fi
          
          # Verify Python 3.12 installation
          echo "Verifying Python 3.12 installation..."
          /usr/local/bin/python3.12 --version
          /usr/local/bin/pip3.12 --version || echo "pip3.12 not found, using ensurepip"
          
          # Setup Python virtual environment with Python 3.12
          echo "Setting up Python 3.12 virtual environment..."
          /usr/local/bin/python3.12 -m venv venv
          source venv/bin/activate
          
          # Verify we're using Python 3.12 in virtual environment
          python --version
          pip --version
          
          # Install Python dependencies
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Create production environment file
          echo "Creating production environment file..."
          sudo tee .env > /dev/null << ENV_EOF
        MONGO_URI=${{ secrets.MONGO_URI }}
        TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        WHATSAPP_VERIFY_TOKEN=${{ secrets.WHATSAPP_VERIFY_TOKEN }}
        WHATSAPP_ACCESS_TOKEN=${{ secrets.WHATSAPP_ACCESS_TOKEN }}
        WHATSAPP_PHONE_NUMBER_ID=${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}
        FLASK_ENV=production
        ENV_EOF
          
          # Create log directory
          sudo mkdir -p /var/log/aliran-tunai
          sudo chown ec2-user:ec2-user /var/log/aliran-tunai
          
          # Copy and enable systemd services
          echo "Setting up systemd services..."
          if [ -f "deploy/aliran-tunai.service" ]; then
            echo "Using service files from deploy/ directory..."
            sudo cp deploy/aliran-tunai.service /etc/systemd/system/
            sudo cp deploy/aliran-api-server.service /etc/systemd/system/
            sudo cp deploy/aliran-whatsapp.service /etc/systemd/system/
          elif [ -f "aliran-tunai.service" ]; then
            echo "Using service files from root directory..."
            sudo cp aliran-tunai.service /etc/systemd/system/
            sudo cp aliran-api-server.service /etc/systemd/system/
            sudo cp aliran-whatsapp.service /etc/systemd/system/
          else
            echo "❌ ERROR: No systemd service files found!"
            ls -la deploy/ || echo "deploy/ directory not found"
            ls -la *.service || echo "No service files in root"
            exit 1
          fi
          echo "Service files copied successfully"
          sudo systemctl daemon-reload
          
          # Start all services
          echo "Starting all services..."
          sudo systemctl enable aliran-tunai
          sudo systemctl enable aliran-api-server
          sudo systemctl enable aliran-whatsapp
          sudo systemctl restart aliran-tunai
          sudo systemctl restart aliran-api-server
          sudo systemctl restart aliran-whatsapp
          
          # Wait for services to start
          echo "Waiting for services to initialize..."
          sleep 15
          
          # Run pre-deployment health checks with Python 3.12
          echo "Running pre-deployment health checks..."
          source venv/bin/activate
          echo "Python version in virtual environment: $(python --version)"
          echo "Testing Python 3.10+ union syntax..."
          python -c "def test_union_syntax() -> dict | None: return {'test': 'success'}; print('✅ Python 3.10+ union syntax works!'); print('Result:', test_union_syntax())"
          python scripts/health_check.py || {
            echo "❌ Health check failed, but continuing deployment..."
            echo "Checking service status:"
            sudo systemctl status aliran-tunai --no-pager || true
            sudo systemctl status aliran-api-server --no-pager || true
            sudo systemctl status aliran-whatsapp --no-pager || true
            echo "Checking logs:"
            sudo journalctl -u aliran-tunai --no-pager -n 20 || true
            sudo journalctl -u aliran-api-server --no-pager -n 20 || true
            sudo journalctl -u aliran-whatsapp --no-pager -n 20 || true
          }
          
          # Verify deployment
          echo "Verifying all services..."
          sleep 5
          sudo systemctl is-active aliran-tunai || echo "aliran-tunai not active"
          sudo systemctl is-active aliran-api-server || echo "aliran-api-server not active"  
          sudo systemctl is-active aliran-whatsapp || echo "aliran-whatsapp not active"
          
          # Check service status
          echo "Service status summary:"
          sudo systemctl status aliran-tunai --no-pager -l || true
          sudo systemctl status aliran-api-server --no-pager -l || true
          sudo systemctl status aliran-whatsapp --no-pager -l || true
          
          # Setup nginx if needed
          if [ ! -f /etc/nginx/conf.d/aliran-tunai.conf ]; then
            echo "Setting up nginx..."
            sudo yum install -y nginx
            sudo cp deploy/nginx.conf /etc/nginx/conf.d/aliran-tunai.conf
            sudo nginx -t && sudo systemctl reload nginx
          fi
          
          # Clean up
          rm -f /tmp/deployment-package.tar.gz
          
          echo "Deployment completed successfully!"
        EOF
        
    - name: Post-deployment verification
      if: always()  # Run even if previous steps had issues
      run: |
        echo "Running post-deployment verification..."
        sleep 30  # Allow services to fully start
        
        # Test API endpoints with proper URL encoding and redirects (non-blocking)
        echo "Testing health endpoint..."
        if curl -f -L http://${{ secrets.EC2_HOST }}/health; then
          echo "✅ Health endpoint accessible via nginx"
        elif curl -f http://${{ secrets.EC2_HOST }}:5001/health; then
          echo "✅ Health endpoint accessible via direct port 5001"
        else
          echo "⚠️ Health endpoint not accessible (may be nginx config issue)"
        fi
        
        echo "Testing WhatsApp webhook endpoint..."
        if curl -f -L "http://${{ secrets.EC2_HOST }}/whatsapp/webhook?hub.verify_token=${{ secrets.WHATSAPP_VERIFY_TOKEN }}&hub.challenge=test&hub.mode=subscribe"; then
          echo "✅ WhatsApp webhook accessible via nginx"
        elif curl -f "http://${{ secrets.EC2_HOST }}:5002/whatsapp/webhook?hub.verify_token=${{ secrets.WHATSAPP_VERIFY_TOKEN }}&hub.challenge=test&hub.mode=subscribe"; then
          echo "✅ WhatsApp webhook accessible via direct port 5002"
        else
          echo "⚠️ WhatsApp webhook not accessible (may be nginx config issue)"
        fi
        
        echo "Post-deployment verification completed (non-blocking)!"
        echo "Services should be running even if nginx proxy needs configuration."
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deployment to EC2 successful!"
        else
          echo "❌ Deployment to EC2 failed!"
        fi

  # ============= ROLLBACK JOB =============
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: [deploy]
    
    steps:
    - name: Rollback on EC2
      run: |
        ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "Starting rollback process..."
          cd /opt/aliran-tunai
          
          if [ -d "backup" ]; then
            echo "Rolling back to previous version..."
            sudo systemctl stop aliran-tunai || true
            sudo systemctl stop aliran-whatsapp || true
            
            sudo rm -rf current
            sudo mv backup current
            
            cd current
            source venv/bin/activate || (python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt)
            
            sudo systemctl start aliran-tunai
            sudo systemctl start aliran-whatsapp
            
            echo "Rollback completed!"
          else
            echo "No backup found, cannot rollback!"
            exit 1
          fi
        EOF